<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot App ID Login</title>
    <link type="text/css" href="css/style.css" rel="stylesheet" />
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/js-cookie/js.cookie.js"></script>
    <script type="text/javascript">
        $.ajaxSetup({
                beforeSend : function(xhr, settings) {
                    if (settings.type == 'POST' || settings.type == 'PUT'
                        || settings.type == 'DELETE') {
                        if (!(/^http:.*/.test(settings.url) || /^https:.*/
                            .test(settings.url))) {
                            // Only send the token to relative URLs i.e. locally.
                            xhr.setRequestHeader("X-XSRF-TOKEN",
                                Cookies.get('XSRF-TOKEN'));
                        }
                    }
                }
            });
        $.get("/user", function(data) {
            $("#user").html(data.userAuthentication.details.name);
            $("#userSub").html(data.userAuthentication.details.sub);
            $("#userEmail").html(data.userAuthentication.details.email);
            $("#provider").html(data.userAuthentication.details.identities[0].provider);
            $(".unauthenticated").hide()
            $(".authenticated").show()
        }).fail(function() {
            $(".unauthenticated").show()
            $(".authenticated").hide()
        });
 
        <!-- In this case, we will call GET /userInfo, and this will give us back a string with userinfo details from Principal user -->
        $.get("/userInfo", function(data) {
            $("#userInfoString").html(data);
            $(".unauthenticated").hide()
            $(".authenticated").show()
        }).fail(function() {
            $(".unauthenticated").show()
            $(".authenticated").hide()
        });
        
        function calculateSum() {
            var sum = 0;
            for (var i = 1; i <= 10; i++) {
    			var element = document.getElementById("price_"+i);

   		  		if (element.checked) {
     			 	sum += Number(element.value);
     			}
    		}
       		document.getElementById('total').innerText = sum.toFixed(2);
    	}
        
        var getProductsList = function(response) {
            $.get("/getProductData", function(response) {
            	<!--console.log(response.userAccountId);-->
            	console.log(response.productDto);
            	var productHtml = '<table border="1" style="width:100%" id="productData"><td>Product Code</td><td>Product Name</td><td>Price</td><td>Select Quantity</td>';
            	var products = response.productDto;
            	var i;
            	for (i = 0; i < products.length; i++) {
            		var productData= '<tr>'
            		+'<td><input id="'+products[i].productCode+'" type="checkbox" value="'+products[i].productCode+'"/></td>'
            		+'<td><label for="productName_'+products[i].productCode+'">'+products[i].productName+'</label></td>'
            		+'<td><label for="price_'+products[i].productCode+'">'+products[i].price+'</label></td>'
            		+'<td><input type="text" id="quantity_'+products[i].productCode+'" name="quantity"></td></tr>';

            		productHtml += productData;
            	}
            	var total = '<tr>'
        					+'<td colspan="2">Total</td>'
        					+'<td class="sum" id="total"></td>'
        					+'</tr>';
        		<!--productHtml += total;-->
            	productHtml += "</table>";
            	document.getElementById("productDataDiv").innerHTML = productHtml;
            	<!--document.getElementById("userAccountId").value=response.userAccountId;-->
            	$("#result").hide();
            	$("#productDataDiv").show(1000);
            	$("#clearSelected").show(1000);
            	$("#checkoutOrder").show(1000);
            })
            return true;
        }
        
        function clearSelected() {
        	$('input:checkbox').removeAttr('checked');
        }
        function checkoutOrder() {
        	var data= "";
        	var json = [];
        	<!--var userAccountId = document.getElementById("userAccountId").value;-->
        	var orderDto = new Array();
        	var myCheckboxes = new Array();
        	$('input:checked').each(function () {
            	myCheckboxes.push($(this).val());
            });
        	for (i = 0; i < myCheckboxes.length; i++) {
        		 var obj = {};
        		
        		var quantityId= "quantity_" +myCheckboxes[i];
        		
        		var itemJSONObject= {
        				"ProductCode":myCheckboxes[i],
        				"quantity":document.getElementById(quantityId).value
        				};
        		console.log("itemJSONObject:" + itemJSONObject);
        		json.push(itemJSONObject);
        		<!-- orderDto.push(itemJSONObject); */-->
        	}
        	var finalJSON = JSON.stringify(json);
        	var orderJSONObject= {
                    <!--"userAccountId":userAccountId,-->
                    <!--"orderDto":orderDto -->
                    serviceToken : finalJSON
                    };
        	console.log("orderJSONObject:" + finalJSON);
     
        	$.ajax({
        	      type : "POST",
        	      <!--contentType : "application/json",-->
        	      url :  "checkoutOrder",
        	      data : orderJSONObject,
        	      <!--dataType : 'json',-->
        	      success : function(result) {
        	    	  $("#productDataDiv").hide();
        	    	  $("#clearSelected").hide();
        	    	  $("#checkoutOrder").hide();
        	    	  document.getElementById("result").innerHTML = "<h2>Thank You! Your Order Number is : "+result+"</h2>";
        	    	  $("#result").show();
        	          console.log("Success" + result);
        	      },
        	      error : function(e) {
        	        console.log("ERROR: ", e);
        	      }
        	    });
        }
 
        var logout = function() {
            $.post("/logout", function() {
                $("#user").html('');
                $(".unauthenticated").show();
                $(".authenticated").hide();
            })
            return true;
        }
    </script>
 
</head>
<div class="container unauthenticated" style="text-align: center;">
    <a href="/login">Login</a>
</div>
<div class="container authenticated" style="text-align: center;" >
    <strong>Logged in as: <span id="user"></span></strong>
    <br>
    <br>
    <strong>Email: </strong><span id="userEmail"></span>
    <br>
    <br>
    <br>
    <div id="product" class="container" style="text-align: center;">
    	<button onClick="getProductsList();">GetProducts</button>
	</div>
	<br>
	<div id="productDataDiv" style="display: none;">
	</div>
	<br>
	<div class="container" style="text-align: right;">
    	<input type="button" id="clearSelected" onClick="clearSelected();" value="Clear Selected" style="display:none;"/>
	</div>
	<div class="container" style="text-align: center;">
   	 <input type="button" id="checkoutOrder" onClick="checkoutOrder();" value="Checkout" style="display:none;"/>
	</div>
	
	<div id="result" style="display:none;">
	</div>
    <button onClick="logout()">Logout</button>
    </div>
 
</div>
</body>
</html>